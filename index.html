<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" href="assets/css/reset.css">
		<link rel="stylesheet" href="assets/css/style.css">
		<title>Star Wars RPG</title>
	</head>
	<body>
		<canvas id="starfield"></canvas>
		<div id="wrapper">
			<div id="screen">
				<h1>Star Wars RPG</h1>
				<h1 id="loading">Loading...</h1>
				<div id="characters">

				</div>
			</div>
		</div>

		<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha384-xBuQ/xzmlsLoJpyjoggmTEz8OWUFM0/RC5BsqQBDX2v5cMvDHcMakNTNrHIW2I5f" crossorigin="anonymous"></script>
		<script src="assets/js/starfield.js" charset="utf-8"></script>
		<script src="assets/js/game.js" charset="utf-8"></script>
		<script type="text/javascript">
		var starfieldCanvas = $("#starfield")[0];
		var starfield;
		var characters = new Array();
		var json = {
			"luke": {
				"name": "Luke Skywalker",
				"weapon": "Lightsaber",
				"power": 4,
				"health": 90,
				"color": "#68C1E5"
			},
			"leia": {
				"name": "Princess Leia Organa",
				"weapon": "Blaster",
				"power": 8,
				"health": 130,
				"color": "#32C560"
			},
			"trooper": {
				"name": "Startrooper XJ-72",
				"weapon": "Blaster",
				"power": 12,
				"health": 140,
				"color": "#EEEEEE"
			},
			"vader": {
				"name": "Darth Vader",
				"weapon": "Lightsaber",
				"power": 16,
				"health": 310,
				"color": "#E96B5F"
			}
		};
		var game;

		function drawScreen() {
			starfieldCanvas.width = document.body.clientWidth;
			starfieldCanvas.height = document.body.clientHeight;
			starfield.draw();

			if (game != undefined) {
				$("#characters").empty();
				switch (game.state) {
					case "NEW_GAME":
						for (var i = 0; i < game.characters.length; i++) {
							var char = game.characters[i];
							$("#characters").append(new CharacterView(char));
						}
						$("<div>").addClass("clear").appendTo($("#characters"));
						break;
					case "CHOOSE_PLAYER":
					case "CHOOSE_OPPONENT":
					case "FIGHT_SCREEN":
					case "ATTACKING":
					case "GAME_LOST":
					case "GAME_WON":
					default:
						throw "Have not implemented drawing for " + game.state;
				}

				for (var i = 0; i < game.characters.length; i++) {
					var char = game.characters[i];
					var jqCanvas = $("." + char.shortName + " > .charAvatar > .avatarHealth");
					var canvas = jqCanvas[0];
					canvas.width = canvas.clientWidth;
					canvas.height = canvas.clientHeight;
					var r = canvas.clientWidth * 0.5;
					if (char.health > 0) {
						var healthFraction = char.health / char.maxHealth;
						var healthTheta = (1.5 - 2*healthFraction)*Math.PI;
						var ctx = canvas.getContext("2d");
						ctx.lineWidth = 4;
						ctx.strokeStyle = jqCanvas.attr("brandcolor");
						ctx.beginPath();
						ctx.arc(r, r, r-3, healthTheta, Math.PI*1.5);
						ctx.stroke();
					}
				}
			}
		}

		// var lastFrame = Date.now();
		function drawLoop() {
		// var delta = Date.now() - lastFrame;
		// lastFrame += delta;
		// console.log(delta);
			drawScreen();
			requestAnimationFrame(drawLoop);
		}

		$(document).ready(function() {
			starfieldCanvas.width = document.body.clientWidth;
			starfieldCanvas.height = document.body.clientHeight;
			starfield = new Starfield(starfieldCanvas);

			// $.getJSON("assets/js/characters.json", function(json) {
				for (shortName in json) {
					var c = json[shortName];
					var char = new Character(shortName, c.name, c.weapon, c.power, c.health, c.color);
					characters.push(char);
				}
				$("#loading").remove();

				game = new Game(characters, drawScreen);
				game.handleCurrentState();
			// });
		});

		$(window).resize(function() {
			drawScreen();
		});
		</script>
	</body>
</html>
