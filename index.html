<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" href="assets/css/reset.css">
		<link rel="stylesheet" href="assets/css/style.css">
		<title>Star Wars RPG</title>
	</head>
	<body>
		<canvas id="starfield"></canvas>
		<div id="wrapper">
			<div id="screen">
				<h1>Star Wars RPG</h1>
				<h1 id="loading">Loading...</h1>
			</div>
		</div>

		<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha384-xBuQ/xzmlsLoJpyjoggmTEz8OWUFM0/RC5BsqQBDX2v5cMvDHcMakNTNrHIW2I5f" crossorigin="anonymous"></script>
		<script src="assets/js/starfield.js" charset="utf-8"></script>
		<script src="assets/js/game.js" charset="utf-8"></script>
		<script type="text/javascript">
		var starfieldCanvas = $("#starfield")[0];
		var starfield;
		var characters = {};


		function drawScreen() {
			starfieldCanvas.width = document.body.clientWidth;
			starfieldCanvas.height = document.body.clientHeight;
			starfield.draw();

			$(".avatarHealth").each(function() {
				var canvas = $(this)[0];
				canvas.width = canvas.clientWidth;
				canvas.height = canvas.clientHeight;
				var r = canvas.clientWidth * 0.5;
				var char = characters[$(this).attr("name")];
				if (char.health > 0) {
					var healthFraction = char.health / char.maxHealth;
					var healthTheta = (1.5 - 2*healthFraction)*Math.PI;
					var ctx = canvas.getContext("2d");
					ctx.lineWidth = 4;
					ctx.strokeStyle = $(this).attr("brandcolor");
					ctx.beginPath();
					ctx.arc(r, r, r-3, healthTheta, Math.PI*1.5);
					ctx.stroke();
				}
			});

			for (c in characters) {
				var char = characters[c];
				var status = $("." + c + " > .charDescription > .charStatus");
				status.text("POW: " + char.attackPower + " HP: " + char.health);
				console.log(status)
			}
		}

		// var lastFrame = Date.now();
		function drawLoop() {
		// var delta = Date.now() - lastFrame;
		// lastFrame += delta;
		// console.log(delta);
			drawScreen();
			requestAnimationFrame(drawLoop);
		}

		$(document).ready(function() {
			starfieldCanvas.width = document.body.clientWidth;
			starfieldCanvas.height = document.body.clientHeight;
			starfield = new Starfield(starfieldCanvas);

			$.getJSON("assets/js/characters.json", function(json) {
				for (shortName in json) {
					var c = json[shortName];
					var char = new Character(shortName, c.name, c.weapon, c.power, c.health, c.color);
					characters[shortName] = char;
					$("#screen").append(CharacterView(char));
				}
				$("<div>").addClass("clear").appendTo($("#screen"));
				$("#loading").remove();
				drawScreen();
			});
		});

		$(window).resize(function() {
			drawScreen();
		});
		</script>
	</body>
</html>
